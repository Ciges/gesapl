#!/bin/bash

# Script de generación de informes de uso de GesApl
# Genera un informe con 
# - Relación de programas monitorizados (sus nombres)
# - Última hora de cada uno de esos programas. Si funcionan y el momento de su último control.
# - Relación de los últimos 20 comandos ejecutados en GesApl y de los parámetros que se le envíaron así como de la fecha y hora de su ejecución

# CONFIGURACIÓN
CONFIG_FILE="/etc/gesapl/gesapl.conf"
GESAPLINFO_VERSION="1.00"

# FUNCIONES
function help {
    printf "%s\n"  "GesApl Informes v${GESAPLINFO_VERSION} - Informe de uso de GesApl"

    printf "\nUso: gesaplinfo [ email ]

    Este script genera un informe de uso de GesApl y si se indica un email lo envía por correo.

    El informe consta de
    - Una relación de programas monitorizados (sus nombres)
    - Última hora de cada uno de esos programas. Si funcionan y el momento de su último control
    - Relación de los últimos 20 comandos ejecutados en GesApl, con sus parámetros, fecha y hora de ejecución y usuario que lo lanzó


"
}

# INICIO DEL CODIGO
if ! [[ -r ${CONFIG_FILE} ]];  then
    printf "ERROR: %s!\n\n" "Fichero de configuración ${CONFIG_FILE} no encontrado o imposible de leer"
    help
    exit 1
fi;

source ${CONFIG_FILE}


# Registramos el comando
log_command "gesaplinfo $@"

# Parseamos los argumentos
if [[ $# -gt 1 ]]; then
    printf "ERROR %s\n\n" "Número de parámetros incorrecto"
    help
    exit 1
elif [[ $# -eq 1 ]]; then
    if [[ $1 == "-a" ]]; then
        help
        exit 0
    else
        email=$1
       
    fi;
    shift
fi;


# INICIO DEL CODIGO

# Colores
GREEN='\e[1;32m'
RED='\e[1;31m'
NC='\e[0m' # No Color

now="$(date +'%b %e %T')"

printf "%s\n\n"  "GesApl Informes v${GESAPLINFO_VERSION}"

printf "%s\n\n" "Informe de uso de GesApl: ${now}"

printf "\n%s\n\n" "--------------------------------------------------------------"

list_active_services="$(active_services)"
printf "Servicios monitorizados: $list_active_services\n"

printf "\nEstado actual del demonio: "
if gesapld_started; then
    printf "${GREEN}Activo${NC}"
else
    printf "${RED}Inactivo${NC}"
fi;
printf "\n"

printf "\nEstado de cada servicio: \n"
for s in $(configured_services); do
    printf "\n\t- %s: " ${s}

    service_status_message="$(monitor ${s})"
    if [[ $? -eq 0 ]]; then 
        printf "${GREEN}Activo${NC}\n"
    else
        printf "${RED}Inactivo${NC}\n"
    fi;

    if ! echo "$list_active_services" | grep -qP "(^|\s+)${s}(\$|\s+)"; then
        printf "\t  %s\n" "Este servicio no está siendo actualmente monitorizado"
    fi;
    last_control="$(grep "$(printf "${log_monitor_service_format}" ${s})" "${log_file}"|tail -n1)"
    printf "\t  Último control realizado: "
    if [[ -n ${last_control} ]]; then
        printf "%s\n" "${last_control}"
    else
        printf "%s\n" "No hay registros"
    fi;

    [[ -n ${service_status_message} ]] && printf "\t  Error obtenido: %s\n" "${service_status_message}"


done

printf "\n%s\n\n" "--------------------------------------------------------------"

printf "Últimos 20 comandos ejecutados en GesApl (y usuario que los ejecutó)\n\n"
if [[ -r ${log_commands_file} ]]; then
    tail -n20 "${log_commands_file}"|tac|while read l; do
        printf "\t  %s\n" "${l}"
    done
else
    printf "%s\n" "No hay registros"
fi;


printf "\n%s\n\n" "--------------------------------------------------------------"

printf "Servicios configurados: $(configured_services)\n"

printf "Configuración registrada:\n"
for s in $(configured_services); do
    config="$(service_configuration ${s})"
    printf "\t- %s\n" "${config}"
done;




