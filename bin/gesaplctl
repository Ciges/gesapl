#!/bin/bash

# Script de control de servicios monitorizados por GesApl
# Permite arrancar, detener y reinicar los servicios configurados en GesApl

# CONFIGURACIÓN
CONFIG_FILE="/etc/gesapl/gesapl.conf"
GESAPLCTL_VERSION="1.00"

# FUNCIONES
function help {
    printf "%s\n"  "GesApl Control v${GESAPLCTL_VERSION} - Control de servicios monitorizados por GesApl"

    printf "\nUso: gesaplctl orden parámetros

Siendo orden una de las siguientes: --arrancar_servicio (o -as), --detener_servicio (o -ds), --reiniciar_servicio (o -rs), --listar-servicios (o -ls), --ayuda (o -a)

    -as | --arrancar_servicio nombre :  arranca el servicio configurado con ese nombre

    -ds | --detener_servicio nombre :  detieene el servicio configurado con ese nombre

    -rs | --arrancar_servicio nombre :  reinicia el servicio configurado con ese nombre

    -ls | --listar_servicios :  Lista los servicios configurados y los parámetros registrados para cada uno

    -a | --ayuda :  Muestra este mensaje explicativo

Este script se debe de ejecutar con derechos de 'root'

"
}

# INICIO DEL CODIGO
if ! [ -r ${CONFIG_FILE} ];  then
    printf "ERROR: %s!\n\n" "Fichero de configuración ${CONFIG_FILE} no encontrado o imposible de leer"
    help
    exit 1
fi;

source ${CONFIG_FILE}


# Parseamos los argumentos
if [[ $# -eq 0 ]]; then
    printf "ERROR %s\n\n" "Número de parámetros incorrecto"
    help
    exit 1
fi;

case $1 in
    -as|--arrancar_servicio)
        comando="as"
        shift
        nombre=$1
        shift

        if [ -z "${nombre}" ]; then
            printf "ERROR %s\n\n" "Número de parámetros incorrecto"
            help
            exit 1
        fi
        ;;
    -ds|--detener_servicio)
        comando="ds"
        shift
        nombre=$1
        shift

        if [ -z "${nombre}" ]; then
            printf "ERROR %s\n\n" "Número de parámetros incorrecto"
            help
            exit 1
        fi
        ;;
    -rs|--reiniciar_servicio)
        comando="as"
        nombre=$1
        shift

        if [ -z "${nombre}" ]; then
            printf "ERROR %s\n\n" "Número de parámetros incorrecto"
            help
            exit 1
        fi
        ;;
    -ls|--listar_servicios)
        comando="ls"
        shift
        ;;
    -a|--ayuda)
        help
        ;;
    *)
        printf "ERROR %s\n\n" "Orden no reconocida"
        help
        exit 1
        ;;
esac;

case ${comando} in
	"ls")
		$(echo ${monitor_services}|awk '{ print $1 }') -ls
		;;
	"as")
	    printf "%s\n\n"  "GesApl Control v${GESAPLCTL_VERSION} - Control de servicios monitorizados por GesApl"

        service_info_file="${services_data}/${nombre}"
        if ! [[ -r ${service_info_file} ]]; then
        	printf "ERROR: %s\n\n" "El servicio ${nombre} no está configurado (no existe o no se puede leer ${services_data}/${nombre}"
        	exit 1
        fi;

        service_info="$(cat ${service_info_file})"

        service_script="/etc/init.d/$(echo ${service_info}|cut -f1 -d',')"
        pid_file="$(echo ${service_info}|cut -f2 -d',')"
        service_executable="$(echo ${service_info}|cut -f3 -d',')"

        if [ -z "${service_info}" -o -z "${service_script}" -o -z "${pid_file}" -o -z "${service_executable}" ]; then
        	printf "ERROR: %s\n\n" "La configuración del servicio ${nombre} no está completa (verificar ${services_data}/${nombre})"
        	exit 1
        else
        	##DEBUGprintf "Configuración de %s :  script de arranque=%s, fichero pid=%s, service_executable=%s\n" ${nombre} ${service_script} ${pid_file} ${service_executable}

            # Tenemos toda la información necesaria
            if ! [[ -s ${service_script} ]]; then
            	printf "ERROR: %s\n\n" "El script de arranque y parada ${service_script} para el servicio ${nombre} no existe o ne se puede leer"
            	exit 1
            fi;
            ${service_script} status > /dev/null
            if [[ $? -eq 0 ]]; then
            	printf "ERROR: %s\n\n" "El servicio ${nombre} ya está arrancado"
            	exit 1
            fi;

            # Todo está OK, arrancamos
            ${service_script} start

            # TODO:
            # - Verificar que está correctamente arrancado
            # - Dar de alta su monitorización

        fi;
		;;
	*)
		printf "ERROR: Comando NO IMPLEMENTADO\n"
		;;
esac
