#!/usr/bin/env perl
use strict;
use warnings;
use lib '/usr/local/lib';

# load some modules
use Data::Dumper;
use Getopt::Long qw(GetOptions);
use Pod::Usage qw(pod2usage);
use IO::String;
use Pod::Select;

# GesApl mmodules
use GesApl::App;
use GesApl::Service;


# FUNCTIONS

# Print in standard output the following POD sections: SINOPSIS and USO and exits
# Optional parameters: message, exit value
# - If a message is passed as parameter, the message will be shown after GesApl description and only USO section will be shown
# - As second parameter an exit value could be given
sub help() {
    my $message=shift;
    my $exit_value=shift || 0;

    my $buffer;
    my $io     = IO::String->new($buffer);
    my $parser = Pod::Select->new();

    printf( "\n%s\n", GesApl::App->get_cfg( 'general', 'gesapl_description' ) );
    if ($message) {
        printf( "\n%s\n", $message);
        $parser->select("USO");
    }
    else {
        $parser->select("SINOPSIS|USO");
    }
    printf ("\n");
    
    $parser->parse_from_file( __FILE__, $io );
    $buffer =~ s/=head1\s*//g;

    print $buffer;

    exit $exit_value;
}

# MAIN CODE

# Constant and default values
use constant DESCRIPTION => GesApl::App->get_cfg( 'general', 'gesapl_description' );

# Start!
my $gesapl = GesApl::App->new();


# Parse script options
my ($help, $ms, @rs, $bs, $ls);

GetOptions( 
        'ayuda|a|help|man|?' => \$help,
        'monitorizar_servicios|ms' => \$ms,
        'registrar_servicio|rs=s@{1,4}' => \@rs,
        'borrar_servicio|bs=s' => \$bs,
        'listar_servicios|ls' => \$ls,
    )
    or pod2usage( -exitval => 2, -verbose => 2 );

help() if $help;

# Command: --listar_servicios | -ls
if ($ls) {
    # Only one command is allowed
    &help("ERROR: Parámetros incorrectos, se ha indicado más de un comando", 2) if ($ms or @rs or $bs);

    printf( "\n%s\n", DESCRIPTION );    

    # Get a list of GesApl::Service instances, one for each service registered
    my $services = $gesapl->list_services();
    if ( scalar @{$services} > 0 ) {
        printf ("\nServicios monitorizados: ");
        foreach (@{$services}) {
            printf("%s ", $_->get_name()) if ($_->get_active() eq 1)
        }
        printf ("\n\n");

        printf ("Configuración de los servicios:\n");
        foreach (@{$services}) {
            printf ("\t- %s\n", $_->get_config());
        }
    }
    else {
        printf ("\nNo hay servicios registrado en gesapl\n");
    }
}
# Command: --registrar_servicios | -rs
elsif (@rs) {
    # Only one command is allowed
    &help("ERROR: Parámetros incorrectos, se ha indicado más de un comando", 2) if ($ls or $ms or $bs);

    # DEBUG
    $gesapl->register_service(@rs);
}


__END__

# HELP

=encoding utf8

=head1 NOMBRE

GesApl v2.00 - Aplicación de monitorización de servicios

=head1 SINOPSIS

gesapl2 orden parámetros

Siendo orden una de las siguientes: --monitorizar_servicios (o -ms), --registrar_servicio (o -rs), --borrar_servicio (o -bs), --listar_servicios (o -ls), --ayuda (o -a)

Ejemplos: 

Monitorizar Apache y MySQL

    gesapl --registrar_servicio apache apache2 /var/run/apache2/apache2.pid /usr/sbin/apache2
    gesapl --registrar_servicio mysql mysql /run/mysqld/mysqld.pid /usr/sbin/mysqld

Dejar de monitorizar MySQL

    gesapl --borrar_servicio mysql

=head1 USO

gesapl2 orden parámetros

    -ms | --monitorizar_servicios :  Monitoriza los servicios configurados

    -rs | --registrar_servicio nombre script_de_arranque ruta_pid_file service_executable :  Registra un servicio e inicia su monitorización

        El nombre de servicio es arbitrario, es el nombre con el que gesapl lo va a tratar
        El script de arranque es el nombre del script de arranque/parada en /etc/init.d
        El último parámetro es la ruta del binario con el que se le ve en la lista de procesos del sistema

        Si el servicio ya ha sido configurado y no se desea cambiarla sólo se necesita el nombre

    -bs | --borrar_servicio nombre :  Borra el servicio indicado

    -ls | --listar_servicios :  Lista los servicios monitorizados y los parámetros registrados para cada uno

    -a | --ayuda :  Muestra este mensaje explicativo


=cut
